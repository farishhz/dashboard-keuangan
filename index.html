<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Keuangan</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f7f6; padding: 20px; max-width: 800px; margin: auto; color: #333; }
        .hidden { display: none; }
        .card { background: #ffffff; padding: 30px; margin-bottom: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: none; }
        input, select { padding: 12px 15px; margin: 8px 0; width: 100%; box-sizing: border-box; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        button { padding: 12px 25px; cursor: pointer; background: #4a90e2; color: white; border: none; border-radius: 8px; margin-top: 5px; font-weight: 600; font-size: 16px; transition: background 0.3s; width: 100%; }
        button:hover { background: #357abd; }
        button.secondary { background: transparent; color: #4a90e2; border: 1px solid #4a90e2; margin-top: 10px; }
        .logout-btn { background: #e74c3c; width: auto; padding: 8px 20px; font-size: 14px; }
        .transaction-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }
        .income { color: green; }
        .expense { color: red; }
    </style>
</head>
<body>

    <!-- Halaman Login -->
    <div id="auth-section" class="card">
        <h2>Login / Daftar</h2>
        <input type="email" id="email" placeholder="Email Anda">
        <input type="password" id="password" placeholder="Password Anda">
        <p id="auth-message" style="color: red;"></p>
        <button onclick="handleLogin()">Login</button>
        <button class="secondary" onclick="handleSignUp()">Daftar Akun</button>
    </div>

    <!-- Halaman Dashboard -->
    <div id="app-section" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1>Dashboard Keuangan</h1>
            <button class="logout-btn" onclick="handleLogout()">Logout</button>
        </div>

        <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <h3>Total Saldo</h3>
            <h2 id="total-balance">Rp 0</h2>
        </div>

        <div class="card">
            <h3>Tambah Transaksi</h3>
            <input type="text" id="trans-name" placeholder="Nama Transaksi">
            <input type="number" id="trans-amount" placeholder="Jumlah Uang">
            <select id="trans-type">
                <option value="income">Pemasukan (+)</option>
                <option value="expense">Pengeluaran (-)</option>
            </select>
            <button onclick="addTransaction()">Tambah</button>
        </div>

        <div class="card">
            <h3>Riwayat</h3>
            <ul id="transaction-list" style="list-style: none; padding: 0;"></ul>
        </div>
    </div>

    <!-- Import Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // ==========================================
        // BAGIAN WAJIB DIISI:
        // ==========================================
        const SUPABASE_URL = 'https://dwsqptscrsttqemkbjux.supabase.co'; // GANTI INI
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR3c3FwdHNjcnN0dHFlbWtianV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MzI1NDksImV4cCI6MjA4NDQwODU0OX0.u3nFd0_kBp2QAQA9HLgxo9CQmIOEDSS6AmNpctnKq_4'; // GANTI INI
        // ==========================================

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Element DOM
        const authSection = document.getElementById('auth-section');
        const appSection = document.getElementById('app-section');
        const transactionList = document.getElementById('transaction-list');
        const totalBalanceEl = document.getElementById('total-balance');

        // Cek Login Saat Halaman Dimuat
        window.addEventListener('load', async () => {
            const { data: { session } } = await supabase.auth.getSession();
            updateUI(session);
        });

        supabase.auth.onAuthStateChange((_event, session) => {
            updateUI(session);
        });

        function updateUI(session) {
            if (session) {
                authSection.classList.add('hidden');
                appSection.classList.remove('hidden');
                fetchTransactions();
            } else {
                authSection.classList.remove('hidden');
                appSection.classList.add('hidden');
            }
        }

        // Fungsi Login
        async function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const msgEl = document.getElementById('auth-message');

            if (!email || !password) {
                msgEl.innerText = "Isi email dan password!";
                return;
            }

            const { data, error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) {
                msgEl.innerText = error.message;
            } else {
                msgEl.innerText = "Login berhasil!";
                // UI akan update otomatis via onAuthStateChange
            }
        }

        // Fungsi Daftar
        async function handleSignUp() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const msgEl = document.getElementById('auth-message');

            const { data, error } = await supabase.auth.signUp({ email, password });
            if (error) {
                msgEl.innerText = error.message;
            } else {
                msgEl.style.color = "green";
                msgEl.innerText = "Berhasil daftar! Silakan login.";
            }
        }

        // Fungsi Logout
        async function handleLogout() {
            await supabase.auth.signOut();
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
        }

        // Tambah Transaksi
        async function addTransaction() {
            const name = document.getElementById('trans-name').value;
            const amount = document.getElementById('trans-amount').value;
            const type = document.getElementById('trans-type').value;
            const user = (await supabase.auth.getUser()).data.user;

            if (!name || !amount) return alert("Lengkapi data!");

            const { error } = await supabase
                .from('transactions')
                .insert([{ user_id: user.id, name: name, amount: amount, type: type }]);

            if (error) alert(error.message);
            else {
                document.getElementById('trans-name').value = '';
                document.getElementById('trans-amount').value = '';
                fetchTransactions();
            }
        }

        // Ambil Data
        async function fetchTransactions() {
            const user = (await supabase.auth.getUser()).data.user;
            
            const { data, error } = await supabase
                .from('transactions')
                .select('*')
                .eq('user_id', user.id)
                .order('created_at', { ascending: false });

            if (error) {
                console.error(error);
            } else {
                renderTransactions(data);
            }
        }

        function renderTransactions(transactions) {
            transactionList.innerHTML = '';
            let balance = 0;

            transactions.forEach(t => {
                const li = document.createElement('li');
                li.className = 'transaction-item';
                
                const amountDisplay = t.type === 'income' ? `+ Rp ${t.amount}` : `- Rp ${t.amount}`;
                const colorClass = t.type === 'income' ? 'income' : 'expense';
                
                if (t.type === 'income') balance += parseInt(t.amount);
                else balance -= parseInt(t.amount);

                li.innerHTML = `
                    <span>${t.name}</span>
                    <span class="${colorClass}">${amountDisplay}</span>
                `;
                transactionList.appendChild(li);
            });

            totalBalanceEl.innerText = `Rp ${balance.toLocaleString()}`;
        }
    </script>
</body>
</html>